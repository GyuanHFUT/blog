# Web单张大图浏览缓慢问题解决

### 问题描述
在地铁项目中，现场提供的室内示意图有几十兆大小，直接加载示意图缓慢，web端体验很差。

地铁项目很有多张示意图，可能随时添加多张示意图，整个工作流程必须自动化的处理图片加载。

### 解决方案
首先解决加载单张大图加载缓慢的问题，可以使用切割工具，把图片切割成256×256的一块块图片。小图片的加载速度是很快的，按需加载即可。

其次，需要自动化，那么大体实现自动化的流程是：上传图片--后台切图--保存切图参数--加载切图参数和地图。

上传图片：即把大图片上传至后台准备处理，这里没有处理难度。

后台切图：需要把大图片切成一块块的图片，切割图片的工具有GMapImageCutter工具，可以把图片切割成金字塔的模式，方便放大浏览图片。GMapImageCutter工具是jar包的，需要手动调用，但这样不能满足自动化的使用，需要把对应的工具移动到java后台进行处理，而非手动调用。所以把其jar包反编译，提取有用的代码用在自己的java后台非常有必要。
![avO7tJ.jpg](https://s1.ax1x.com/2020/08/12/avO7tJ.jpg)
保存切图参数：图片切好后，保存对应的url路径，并发布出来，用于使用，在这里比较简单不做描述。
![avOTk4.jpg](https://s1.ax1x.com/2020/08/12/avOTk4.jpg)
加载切图参数和地图：当加载此图时，获得对应的url路径，解析切片，拼成一张图，这里使用openlayers js加载切片，可以方便解析GMapImageCutter切成的googlemap tile格式图片。
第一级有一张图片，命名为t；

第二级有4张图片，命名为

    tq,tr,
    
    tt,ts

第三级有16张图片，命名为

    tqq，tqr，trq，trr
    
    tqt，tqs，trt，trs
    
    ttq，ttr，tsq，tsr
    
    ttt，tts，tst，tss

通过上面三级，可以发现第N层共有（4的N-1次方）张图片，首字符带t，每个位置的图片在下一级解析为q，r ，t，s。比如ttr图片命名，由于处于第三级则名字需要三个for循环确认，第一个字符来自于第一级t，第二个字符来自于第二级对应的tt图片，而第三个字符r处于四个图片的位置的右上用r来表示。大体的算法解析是

    var f=’t’;//起始第一级名称
    
    var tileZ=2;//第三级的下标
    
    var c=Math.pow(2,tileZ);//上一级有4张图片
    
    var d=tileX;//对应传递过来的x位置
    
    var e=tileY;//对应传递过来的y位置
    
    for(var g=0;g<tileZ;g++){
    
            c=c/2;
    
            if(e<c){
    
                if(d<c){f+="q"}//左上角
    
                else{f+="r";d-=c}//右上角
    
            }
    
            else{
    
                if(d<c){f+="t";e-=c}//左下角
    
                else{f+="s";d-=c;e-=c}//右下角
    
            }
    
    }

通过算法解析，正确加载第三级图片，对应的解析路径
![avOHh9.jpg](https://s1.ax1x.com/2020/08/12/avOHh9.jpg)

### 经验总结、预防措施和对规范的建议等

本方案解决了单张大图在web上加载缓慢的问题，从自动切图到自动解析的过程，这种过程类似于切片缓存，用户可以设置切片的层级数，切片可以直接生成到http发布的路径，层级和url保存至数据库，加载时读取即可